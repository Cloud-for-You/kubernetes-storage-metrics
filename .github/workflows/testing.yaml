name: Testing
on:
  workflow_dispatch:
  push:
    branches-ignore:
      - main
      - dev

permissions:
  contents: read

jobs:
  static-code-analysis:
    name: Static code analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          args: --timeout=30m --config=.golangci.yaml --issues-exit-code=0

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    needs: static-code-analysis
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false
      - name: Run unit tests
        run: |
          go test -v ./... -coverprofile=coverage.out -covermode=atomic
          go tool cover -func=coverage.out
          go tool cover -html=coverage.out -o coverage.html
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.html
          retention-days: 7
  
  integration-tests:
    name: Integration tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: alexellis/setup-arkade@v1
      - uses: alexellis/arkade-get@master
        with:
          print-summary: false
          kubectl: latest
          kustomize: latest
          helm: latest
          jq: latest
          yq: latest
      - name: Setup KinD cluster
        run: |
          mkdir ${HOME}/bin
          curl -L -s -o ${HOME}/bin/kubectl https://dl.k8s.io/release/v1.33.0/bin/linux/amd64/kubectl
          chmod +x ${HOME}/bin/kubectl
          curl -L -s -o ${HOME}/bin/kind https://kind.sigs.k8s.io/dl/v0.29.0/kind-linux-amd64
          chmod +x ${HOME}/bin/kind
          kind create cluster --name kind-${{ github.ref_name }} --image kindest/node:v1.31.0 --wait 180s
      - name: Wait for KinD cluster to be ready
        run: |
          ATTEMPTS=30
          SLEEP=10
          for i in $(seq 1 $ATTEMPTS); do
            NOT_READY=$(kubectl get pods -n kube-system --no-headers | grep -v 'Running\|Completed' | wc -l)
            if [ "$NOT_READY" -eq 0 ]; then
              echo "All kube-system pods are running."
              kubectl cluster-info
              exit 0
            fi
            echo "Waiting for cluster to be ready... ($i/$ATTEMPTS)"
            sleep $SLEEP
          done
          echo "Cluster is not ready after $((ATTEMPTS * SLEEP)) seconds."
          exit 1
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false
      - name: Run integration tests
        run: |
          kubectl get nodes -o wide

  create-pull-request:
    name: Create pull request
    runs-on: ubuntu-latest
    needs: integration-tests
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get commit list
        id: commits
        run: |
          commits=$(git log --pretty=format:"- %h %s" origin/dev..HEAD)
          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          echo "$commits" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Create pull request
        id: pull_request
        uses: devops-infra/action-pull-request@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: ${{ github.ref_name }}
          target_branch: dev
          title: "Automated PR from ${{ github.ref_name }}"
          body: |
            ### What changes does this pull request make?
            This pull request includes the latest changes from the branch `${{ github.ref_name }}`.
            
            ### Commits:
            ${{ steps.commits.outputs.COMMITS }}

            ### Checklist:
            - [ ] Code has been reviewed
            - [ ] Tests have been run and passed
            - [ ] Documentation has been updated if necessary
      - name: Check outputs
        if: ${{ steps.pull_request.outputs.pr_number }}
        run: |
          echo "Pull Request Number - ${{ steps.pull_request.outputs.pr_number }}"
          echo "Pull Request URL - ${{ steps.pull_request.outputs.url }}"